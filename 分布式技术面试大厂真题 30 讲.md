# 分布式技术面试大厂真题 30 讲

### 分布式基础篇

* 谈谈你对分布式的理解，为什么引入分布式？

  * 面试官：谈谈你对分布式系统的理解

    什么是分布式系统：

    为了解决传统单体服务架构带来的各种问题，代码数量庞大，迭代测试维护困难，可能因为一处改动测试不到位造成整个服务瘫痪等问题，分布式系统就是将一个大的服务拆分成几十个甚至上百个微小的服务。如果把单体架构服务器比做篮子，那代码就是鸡蛋，不要让所有鸡蛋装在一个篮子里，也方便大家分工开发，代码不在一个项目里，也不会冲突。

    比如 Dubbo、Spring Cloud，都是解决分布式微服务架构的优秀框架。

  * 面试官：分布式系统环境下各自有什么优缺点？

    优点：

    **系统可用性提升**，一个系统全年可用时间在 99.999%，5 个 9 的服务可用率在设计合理的分布式系统中并不是一个触不可及的数字。

    **系统并发能力提升**，请求通过 Nginx 负载均衡被分发到不同的服务器上，运行同样代码的服务器可以有 1 台或 N 台，通常情况下会根据实际用户访问量随时增加机器，无论是数据库或者服务，都可以做到随时水平扩展。

    **系统容错能力提升**，同一组服务分别部署在北京上海杭州，杭州的机房突发断电或者火灾，杭州机房的流量会被自动分发到北京和上海的机房，不影响用户使用。

    **低延迟**，北京的用户请求自动分发到北京，上海的用户请求被分发到上海，服务器会根据用户的 IP 选择距离自己最近的机房，降低网络延迟。

    缺点：

    **分布式服务依赖网络**，服务器间通讯依赖网络，不可靠网络包括网络延时，丢包、中断、异步，一个完整的服务请求依赖一连串服务调用，任意一个服务节点网络出现问题，都可能造成本次请求失败。

    **维护成本高**，传统单体式服务只需要维护一个站点就可以。分布式服务系统被拆分成若干个小服务，服务从 1 变为几十个上百个服务后，增加运维成本。

    **一致性，可用性，分区容错性无法同时满足**，这三种特性就是平时说的 CAP 定理，在分布式系统中，这三种特性最多只能满足两种，无法同时满足，需要根据实际情况去调整牺牲掉其中哪个。

    深入分析：

    关于分布式系统，通俗点讲就把整个业务系统拆分成很多的服务，每个服务责任到人，服务之间代码都没有冲突，服务可以自治，每个服务的技术也可以自己选型，只要遵循统一的服务调用协议就可以了。每次发布如果只改动一个服务那就上线一个服务，不用所有人一起联调，这样每次发布牵扯到的改动影响也是可控的。不像传统单体架构服务，动辄几百万行代码融在一起。

    分布式系统并不是某一门具体的技术，也不是具体的框架。用大白话理解就是将计算能力和数据存储能力分散在不同服务器上，通过网络连接组成的一个整体的服务，不同服务器可能是物理机，也可能是虚拟机，分布式的概念可以理解成一种解决方案。

    分布式系统总结来说是将数据存储能力和计算能力分布到不同的服务器上，作为一个整体对外服务。目的在于解决单台机器的故障问题，单机计算和 IO 性能问题，以及单机存储空间不足的问题。虽然单机故障的概率比较小，但是随着集群规模大了之后，集群宕机和磁盘损坏基本上是常态，分布式系统主要解决的是各种故障带来的问题。

  * 分布式系统和微服务什么关系

    关于分布式系统和微服务，两者都只是一种概念。如果你采用微服务，就意味着系统一定是分布式的，分布式系统具有的优缺点在微服务里都会体现，个人理解微服务是分布式系统的一种具体落地方案。
    
  * 分布式系统一定是集群的吗？

    还要先理解两者的概念。其实分布式不一定就是不同的组件，同一个组件也可以，关键在于是否通过交换信息的方式进行协作。比如说 Zookeeper 的节点都是对等的，但它自己就构成一个分布式系统。也就是说，分布式是指通过网络连接的多个组件，通过交换信息协作而形成的系统。而集群，是指同一种组件的多个实例，形成的逻辑上的整体。可以看出这两个概念并不完全冲突，分布式系统也可以是一个集群，例子就是前面说的 Zookeeper 等，它的特征是服务之间会互相通信协作。是分布式系统不是集群的情况，就是多个不同组件构成的系统；是集群不是分布式系统的情况，比如多个经过负载均衡的 HTTP 服务器，它们之间不会互相通信，如果不带上负载均衡的部分的话，一般不叫做分布式系统。 

* 公司使用什么 RPC 框架，聊聊你理解的 RPC 原理

  * 面试官：公司使用什么 RPC 框架？可以介绍一下 RPC 的工作原理吗？

    RPC 是一个分布式计算的 CS 模式，总是由 Client 向 Server 发出一个执行若干过程请求，Server 接受请求，使用客户端提供的参数，计算完成之后将结果返回给客户端。

    ![RPC 原理](https://github.com/songor/interview/blob/master/picture/RPC%20%E5%8E%9F%E7%90%86.jpg)

    服务集成 RPC 后，服务（这里的服务就是图中的 Provider，服务提供者）启动后会通过 Register（注册）模块，把服务的唯一 ID、IP 地址、端口信息等注册到 RPC 框架注册中心（图中的 Registry 部分）。

    当调用者（Consumer）想要调用服务的时候，通过 Provider 注册时的的服务唯一 ID 去注册中心查找在线可供调用的服务，返回一个 IP 列表（3.notify 部分）。

    Consumer 根据一定的策略，比如随机或轮询从 Registry 返回的可用 IP 列表中选择真正调用的服务（4.invoke）。

    RPC 框架都提供监控功能，监控服务健康状况，控制服务线上扩展和上下线（5.count）

  * 面试官：服务启动的时候服务基本信息被注册到注册中心，如果服务提供者挂了，注册中心如何知道服务不可用了呢？

    服务掉线分为主动下线和心跳检测。

    比如服务发新版本时，在重启之前主动通知注册中心，我要重启了，有流量进来不要分发给我，等我重启成功后再放流量进来，或者在管理后台手动摘掉机器，这个是主动下线。

    心跳检测是处理服务非正常下线（如断电断网）的情况。注册中心增加一个心跳检测功能，它会对服务提供者（Provider）进行心跳检测，比如每隔 30s 发送一个心跳，如果三次心跳结果都没有返回值，就认为该服务已下线，赶紧更新 Consumer 的服务列表，告诉 Consumer 调用别的机器。

  * 面试官：如果注册中心挂了，比如你用的是 Zookeeper，如果 Zookeeper 挂了，那服务之间还能相互调用吗？

    首先注册中心挂掉也要分两种情况，如果数据库挂了，ZK 还是能用的，因为 ZK 会缓存服务列表。

    其次 ZK 本身就是一个集群，一台机器挂了，ZK 会选举出集群中的其他机器作为 Master 继续提供服务，如果整个集群都挂了也没问题，因为调用者本地会缓存从注册中心获取的服务列表，省略和注册中心的交互，Consumer 和 Provider 采用直连方式，这些策略都是可配置的。

  * 面试官：能否自己写一个 RPC 框架？

    ![RPC 框架](https://github.com/songor/interview/blob/master/picture/RPC%20%E6%A1%86%E6%9E%B6.jpg)

  * 已经有 HTTP 协议接口，或者说 RESTful 接口，为什么还要使用 RPC 技术？

    在接⼝不多的情况下，使用 HTTP 确实是一个明智的选择，开发简单、测试也比较直接、部署方便，利用现成的 HTTP 协议进行系统间通讯。

    如果业务慢慢做大，系统也慢慢扩大，RPC 框架的好处就显示出来了：

    ⾸先 RPC 支持长链接，通信不必像 HTTP 一样每次去重复 3 次握⼿，减少了网络开销。

    其次 RPC 框架一般都有注册中心模块，有完善的监控管理功能，服务注册发现、服务下线、服务动态扩展等，服务化治理效率大大提高。

    基于 TCP 协议实现的 RPC，能更灵活地对协议字段进行定制，相比 HTTP 能减少网络传输字节数，降低网络开销（握手），提高性能，实现更大的吞吐量和并发数，但是需要更多地关注底层复杂细节， 对开发人员的要求也较高，增加开发成本。

* 